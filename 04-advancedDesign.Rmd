
# Advanced Designs

In the previous two chapters, you have seen different experimental designs where a factor or factors are manipulated by the researcher in order to measure a response.   In simpler design settings, the factors that are manipulated are of the “between-subjects” type.  The one-way ANOVA example in chapter 2 on drug effects on alertness is illustrative of this: each participant (experimental unit) had exactly one drug randomly assigned to them.  As such, there is only one observation per experimental unit in the design. Drug was a **between-subjects factor**.

*Why is that important to note?*  Because, as you should realize by now, that assures that the observations in the data are all independent.  It will be elaborated upon later in this course how crucial this assumption is to the validity of any statistical inferences we draw from the tests/CIs we derive.  In fact, independence is more important to inference validity than either normality or constant variance assumptions.

Now, contrast this with the **paired $t$-test** (see section 2.4).  The example we saw there involved giving a sample of 20 mics a dietary treatment drug in order to study its effect on the weight of the mice. Let’s think of that problem from a design of experiments point of view: what was/were the factor(s) that were manipulated by the researcher?

* It wasn’t the diet!  Why? Because in the experiment, only one diet was studied: there was no “comparison” diet or placebo used to form a basis for comparison.  As such, the dietary treatment in that problem was not a variable at all: it was a constant.
* So what is left? The answer is TIME. The researcher measured weight at two time points on each mouse (experimental unit): [1] just before the start of the diet, and [2] three months later.  The factor here is time, and it has two levels. Time is a **within-subject factor**.

In a designed experiment that involves several measurements made on the same experimental unit over time, the design is called a **repeated measures design**.

The important thing to recognize here is that each mouse provided two observations, not one.  It stands to reason that *what a particular subject’s weight is after three months might have something to do with (i.e. be related to) what their starting weight was before the diet*.   That’s the layman’s way of saying that the measurements within a subject are **not independent** (i.e. correlated).  If in any analysis we ignored this basic truth, that analysis would be seriously flawed.

So how did we handle this before?  A simple strategy which is common with paired data comparisons is to calculate each subject’s difference score (yielding a single difference measurement per subject) and then performing a one-sample t-test on the differences.  Each difference score is independent, because each came from a different randomly chosen subject.  This is what was done in the paired t-test analysis in section 2.4.  Check back and remind yourself of this.

## Blocks revisited: an approach to handling within-subjects factors

The notion and purpose of blocking in an experimental design was introduced in section 3.1.  If you recall that witty definition of blocks as relatively homogenously sets of experimental material, it may occur to you that subjects can serve as blocks.  In fact, this was already stated in section 3.1.  What this means for us now is that using a block design approach to analysis is a way to handle correlated (non-independent) observations such as in the paired $t$-test problem above.  We illustrate that here.

**Example.** 20 mice received a dietary treatment during 3 months. We want to know whether the dietary treatment has an impact on the weight of the mice. To answer to this question, the weight of the 20 mice has been measured before and after the treatment and is in the file `mice.csv`. Below is some code to quickly look at the data:

```{r, eval=FALSE}
mice <- read.csv("http://www.users.miamioh.edu/hughesmr/sta363/miceWeighttallform.csv")
head(mice)
```

```{r ch4.1, echo=FALSE}
mice <- read.csv("miceWeighttallform.csv")
head(mice)
```

Note the difference in the layout of the data here as compared to the file miceWeightwideform.csv used in the paired t-test in section 2.4.  The data here is in what is called “tall mode”: each observation occupies a single row of the data file now, and there is a new variable (id) that identifies which subject every observation belongs to. The variable group refers to the time factor.

We will analyze this same data (addressing the same research question) by using a **block design approach**:

```{r ch4.2}
mice.block.aov <- aov(weight ~ factor(id) + group, data=mice)
summary(mice.block.aov)
```

Look at the F-test for the time factor (labeled group here).  This is identical to the result of the paired t-test in section 2.4 (F = 436.11, df1 = 1, df2 = 9, p-value = 6.2 × 10-9).  

*How does the block approach work here?*  You’ll note that the test of group (the within subjects effect) uses the residual effect as the error term.  Because the blocks are accounted for in the model (and here, the blocks constitutes the overall between-mice variability source), the only variation left over for the “residuals” is the variability due to the within-mouse differences.  In essence, there are **two components** to the random error now:

* Aggregated variability between mice (block effect)
* Remaining unexplained (random) variability after accounting for aggregate mouse-to-mouse differences and aggregated time-to-time differences.  We’ll call this leftover stuff “pure” error.

For a correct analysis, it is important that each factor of interest in the study be tested against the proper component of the error.  Here, **we test a within-subjects effect against the random error component dealing with “pure” random error**.

**A more generalized approach.**  Perhaps a more general approach to within-subjects analysis of such data is to specify to R the fact that there are layers of random variability in the data introduced by the fact that we have more than one measurement per experimental unit.  This can be done using an `aov` model specification that explicitly cites these layers with an Error option.  The model specification in R is generally

    `aov(response ~ between-subjects factor structure + Error(EU variable/WS factor)`

In the present example, this would be as follows:

```{r ch4.3}
WS_aov <- aov(weight ~ group + Error(factor(id)/group), data=mice)
summary(WS_aov)
```

Again we see the same result.

## A more involved repeated measures case study

If we can handle within-subjects factors using blocks, why not just stick with that all the time?  Well, the reason is that repeated measures designs can get complicated: multiple time measurement points (not just two), the addition of between-subjects factors, etc.  The following case study example illustrates this.

**Example: Cholesterol study.** A study tested whether cholesterol was reduced after using a certain brand of margarine as part of a low fat, low cholesterol diet.  The subjects consumed on average 2.31g of the active ingredient, stanol ester, a day.  This data set `cholesterolreduction.csv` contains information on 18 people using margarine to reduce cholesterol over three time points.  Source: The University of Sheffield.  

```{r ch4tab, echo=FALSE}
tab <- data.frame("Variable Name"=c("ID", "Before", "After4weeks", "After8weeks", "Margarine"),
                  `Variable` = c("Participant Number", "Cholesterol befoore the diet (mmol/L)", "Cholesterol after 4 weeks on diet (mmol/L)", "Cholesterol after 8 weeks on diet (mmol/L)", "Margarine type A or B"),
                  `Data type` = c("", "Scale", "Scale", "Scale", "Binary") )
names(tab) <- c("Variable Name", "Variable", "Data type")
kable(tab)
```


```{r, eval=FALSE}
chol <- read.csv("http://www.users.miamioh.edu/hughesmr/sta363/cholesterolreduction.csv")
glimpse(chol)
```

```{r ch4.4, echo=FALSE}
chol <- read.csv("cholesterolreduction.csv")
glimpse(chol)
```

There are two factors of interest here: 

* `time.pt` (3 levels within-subjects: before, after4weeks, after8weeks)
* `Margarine` (2 level between-subjects: A or B)

Note that the data is currently in wide form.  We need to convert it to tall form:

```{r ch4.5}
library(tidyverse)
chol_tall <- chol %>% 
  gather(time.pt, chol.level, Before:After8weeks, factor_key=TRUE)
head(chol_tall)
```

Note here we specify `factor_key=TRUE`. We do this so the key variable `time.pt` is a `factor` and not a `character` variable.

### Exploratory Data Analysis

We are now ready for some EDA.  A table of descriptive statistics by combinations of time and margarine group is our first cut:

```{r ch4.6}
chol.summary <- chol_tall %>%
  group_by(Margarine, time.pt) %>%
  summarise(Mean = mean(chol.level),
            SD = sd(chol.level),
            SE = sd(chol.level)/sqrt(length(chol.level)),
            n = length(chol.level))
kable(chol.summary)
```

We generally observe that cholesterol levels with margarine A appear lower than with margarine B.  Also, there does appear to be some reduction in cholesterol level using both products: however, there also appears to be more unexplained variability (“noise”) in the cholesterol measurements under margarine A.  We can further check this using some data visualizations.  First let’s try boxplots:

```{r ch4.7}
ggplot(chol_tall) +
  geom_boxplot(aes(x=time.pt, y=chol.level)) +
  facet_wrap(~Margarine) +
  xlab("Time Point of Measurement") +
  ylab("Cholesterol level (mmol/L)")
```

Here we see that perhaps cholesterol levels are generally more consistent under margarine B, and that it is just some outlier(s) that are the issue.  However, this plot does not reveal a crucial piece of information: **the responses are correlated over time**.  A better depiction would allow us to see how each individual subject’s cholesterol changed over the span of the experiment:

```{r ch4.8}
# Plot the individual-level cholesterol profiles
ggplot(chol_tall, aes(x=time.pt, y=chol.level, colour=Margarine, group=ID)) +
  geom_line() + geom_point(shape=21, fill="white") + 
  facet_wrap(~Margarine) +
  xlab("Time Point of Measurement") +
  ylab("Cholesterol level (mmol/L)") +
  ggtitle("Subject-level cholesterol profiles by Margarine group")
```

```{r ch4.9}
# we inlude a position_dodge elements to avoid overlap
ggplot(chol.summary, aes(x=time.pt, y=Mean, colour=Margarine)) + 
  geom_errorbar(aes(ymin=Mean-SE, ymax=Mean+SE), width=.1, position=position_dodge(0.3)) +
  geom_line(aes(group=Margarine), position=position_dodge(0.3)) +
  geom_point(position=position_dodge(0.3)) +
  xlab("Time Point of Measurement") +
  ylab("Cholesterol level (mmol/L)") +
  ggtitle("Mean Cholesterol level (with Standard Error bars)")
```

Now we see some things more clearly.  The general pattern over time appears to be pretty consistent for every experimental unit (visually, each “line” in the plot).  There are two individuals in margarine B whose cholesterol level seems unusually higher than the others: this might warrant further investigation.

### Preliminary inferential analysis

Of more concern to a fully correct analysis is addressing why there appears to be a difference between the margarine groups at the “Before” stage.  At that point, no margarines had been administered, so if the subjects had been truly randomly assigned to the margarine groups (as they should be in a properly designed experiment!), we would have expected consistent cholesterol readings between the groups at that point.  This can be formally tested as follows, with a simple independent samples t-test comparing the mean cholesterol levels of the A and B groups at the “Before” stage:

```{r ch4.10}
BeforeDataOnly <- chol_tall %>%
  filter(time.pt == "Before")
t.test(chol.level ~ Margarine, data=BeforeDataOnly, var.equal=TRUE)
```

The result is not statistically significant (p-value = 0.1932).  That is actually good news here!

### A conditional repeated measures analysis

To get started, let’s do a within-subjects (repeated measures) ANOVA on the Margarine A data only.  The goal here would be to see if there is an effective reduction in mean cholesterol over the eight-week trial by using margarine A.  Here goes: follow the code!

```{r ch4.11}
MargarineA <- chol_tall %>% 
  filter(Margarine == "A")
RMaov_MargA <- aov(chol.level ~ time.pt + Error(factor(ID)/time.pt), data=MargarineA)
summary(RMaov_MargA)
```

The test of interest is labeled time.pt.  It is significant (F = 106.3, df1 = 2, df2 = 16, p-value = 5.7 × 10-10).  What this means is that, using Margarine A, there is significant evidence to conclude that the *true mean cholesterol level differs between at least two of the time points*.  Of course, that result doesn’t mean that the margarine is effective at reducing cholesterol levels.  All it means is that the mean cholesterol level is changing at some point over the experiment.  Since there are three time points, a multiple comparison procedure is warranted:

```{r ch4.12}
MargA.mc <- emmeans(RMaov_MargA, ~ time.pt)
contrast(MargA.mc, "pairwise")
plot(contrast(MargA.mc, "pairwise"))
```

The significant reductions in mean cholesterol level under Margarine A occurs right after the start of the experiment.  The mean cholesterol level is reduced by 0.485 (SE = 0.041) by week 4 (p-value < 0.0001); and by 0.546 (SE = 0.041) by week 8 (p-value < 0.0001).  There is no appreciable change in mean cholesterol level between weeks 4 and 8 (p-value = 0.3229).

### Full analysis: Formal Comparison of Margarines

It is always critically important to know the structure of the data, which here stems from the design of the experiment.  In this case, we cannot just “compared the margarines” because there is a subject-level time profile under each margarine.  Since the same time points are observed under each margarine group, the factors margarine and `time.pt` are crossed effects, which means we have a *factorial data structure* (see section 3.2).  The “wrinkle” here is that one of the two factors is a between-subjects factor (Margarine) and the other is within-subjects (`time.pt`).  But, we can handle this in `aov`: 

```{r ch4.13}
RMaov_all <- aov(chol.level ~ Margarine + time.pt + Margarine:time.pt + 
                              Error(factor(ID)/time.pt), data=chol_tall)
summary(RMaov_all)
```

s with factorials before, the first thing we must check is the significance of the interaction term.  If this is significant, it means that the effect of time on the mean cholesterol is different between the two margarines.  That is the case here (F = 4.777, df1 = 2, df2 = 32, p-value = 0.0153).  As a result, we should do our multiple comparisons **by conditioning on one of the two factors**.  Experimental context will dictate which of the two factors is the more reasonable to condition on.  Here, I choose to condition on Margarine group, so I will get a time-based comparison of mean cholesterol level, but specific to each Margarine group:

```{r ch4.14}
RMall.mc <- emmeans(RMaov_all, ~ time.pt | Margarine)
contrast(RMall.mc, "pairwise")
plot(contrast(RMall.mc, "pairwise"))
```

Even though at first glance the time-based comparisons look about the same between the two margarines, the point estimates and plots reveal the story: the reductions in mean cholesterol following the initiation of the study are larger for margarine B (mean=0.7111 mmol/L, SE=0.043 by week 8) than for margarine A (mean=0.546 mmol/L, SE=0.043 by week 8).  

## Further study

More thorough analysis of within-subjects and repeated measures designs are possible using advanced methods beyond the scope of this course.  These methods include:
* processes that allow the analyst to estimate the degree of correlation between repeated measurements
* processes that allow one to model different correlation structures based upon experimental realities in the data collection process

For example, suppose we had a repeated measures experiment with subjects measured across four time points: Week 1, 2, 3 and 8.  Because of the time spacing, we might expect that measurements between adjacent weeks to be more similar within a subject than weeks far removed in time. For example, it is reasonable to expect that results in week 2 are more strongly correlated to week 1 results than would be the correlation between weeks 3 and 1.  Week 8’s results might be so far removed from the first 3 weeks so that the results there might be safely presumed to be nearly independent of earlier results.  We  could even be more restrictive, using an approach that assumes only adjacent time point results are correlated, but beyond that, assume independence.

Subtleties like this can be modeled and checked using advanced modeling techniques.

